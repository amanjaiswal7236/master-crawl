# SPA Crawling Improvements

## Overview

The crawler has been significantly enhanced to properly handle Single Page Applications (SPAs) that rely on JavaScript for rendering content and navigation.

## Key Improvements

### 1. Enhanced JavaScript Rendering

**Previous Issues:**
- Only waited 2 seconds for SPA rendering
- Didn't wait for dynamically loaded content
- Missed links generated by JavaScript frameworks

**Solutions Implemented:**

#### Extended Wait Times
- Increased timeout from 30s to 60s for navigation
- Multiple polling cycles to detect dynamically loaded links
- Stability checks to ensure content has finished loading

#### Dynamic Content Detection
```javascript
// Polls for dynamically loaded links (SPA specific)
for (let i = 0; i < 5; i++) {
  await page.waitForTimeout(2000);
  // Check if link count has stabilized
  // Only proceed when links are stable for 2 consecutive checks
}
```

#### Scroll-Based Lazy Loading
- Scrolls to bottom of page to trigger lazy-loaded content
- Waits for content to load
- Scrolls back to top
- This ensures all lazy-loaded sections are discovered

#### Router-Based Link Detection
The crawler now detects links from:
- Standard `<a href>` tags
- React Router links (`data-link`, `data-route`)
- Vue Router navigation (`data-navigate`)
- Any element with navigation attributes

### 2. Better URL Handling

**Hash Fragment Handling:**
- Automatically normalizes hash-based URLs
- Converts `example.com/#page` to proper routes
- Handles both History API and hash-based routing

**Relative URL Resolution:**
- Properly resolves relative URLs
- Handles `./`, `../`, and absolute paths
- Converts all to absolute URLs for consistent crawling

### 3. SPA-Specific Features

#### DOM Ready State Check
```javascript
await page.waitForFunction(
  () => document.readyState === 'complete',
  { timeout: 10000 }
);
```

#### Network Idle Detection
- Uses `networkidle2` to wait for network activity to settle
- Ensures AJAX/fetch requests have completed
- Waits for all resources to load

#### Viewport Configuration
- Sets consistent viewport (1920x1080) for reliable rendering
- Ensures responsive layouts render correctly
- Prevents layout shifts during crawling

## Sitemap Formats

### 1. JSON Sitemap
- Complete page information
- Hierarchical structure
- Metadata (depth, parent URLs, titles)

**Endpoint:** `GET /api/crawl/:jobId/download/json`

### 2. XML Sitemap
- Standard XML sitemap format
- Compatible with search engines
- Includes lastmod, changefreq, and priority

**Endpoint:** `GET /api/crawl/:jobId/download/xml`

**Features:**
- Valid XML structure
- Proper escaping of special characters
- Priority based on page depth
- Last modification date

### 3. Tree Diagram
- Visual tree representation
- Shows site structure
- Easy to understand hierarchy

**Endpoint:** `GET /api/crawl/:jobId/download/tree`

**Example Output:**
```
https://example.com
â””â”€â”€ ðŸ“„ Homepage
    https://example.com/
â”œâ”€â”€ products (2 pages)
â”‚   â”œâ”€â”€ ðŸ“„ Product List
â”‚   â”‚   https://example.com/products
â”‚   â””â”€â”€ ðŸ“„ Product Detail
â”‚       https://example.com/products/item-1
â””â”€â”€ blog (5 pages)
    â”œâ”€â”€ ðŸ“„ Blog Home
    â”‚   https://example.com/blog
    â””â”€â”€ ...
```

## Testing SPA Crawling

### Test with Popular SPAs

1. **React Applications:**
   - Ensure React Router is using History API (not hash routing)
   - Test with `create-react-app` and Next.js apps

2. **Vue Applications:**
   - Works with Vue Router
   - Supports both hash and history mode

3. **Angular Applications:**
   - Compatible with Angular Router
   - Handles lazy-loaded modules

### Common Issues Fixed

1. **Not every page has its own URL**
   - âœ… Now detects History API routes
   - âœ… Normalizes hash fragments
   - âœ… Discovers all route-based navigation

2. **Fully client-side rendered**
   - âœ… Extended wait times for JavaScript execution
   - âœ… Multiple rendering checks
   - âœ… Scroll-based lazy loading detection

3. **Dynamic rendering setup**
   - âœ… Works with both CSR and SSR
   - âœ… Detects pre-rendered content
   - âœ… Handles hybrid rendering

4. **JavaScript required sections**
   - âœ… Polls for dynamically generated links
   - âœ… Waits for async content loading
   - âœ… Detects router-based navigation

## Performance Considerations

### Timeout Settings
- Navigation timeout: 60 seconds (increased from 30s)
- Default timeout: 60 seconds
- Stability check: Up to 10 seconds (5 cycles Ã— 2s)

### Resource Usage
- Each page crawl takes longer (10-15 seconds for complex SPAs)
- More memory usage due to extended page lifecycle
- Browser instance is reused for efficiency

### Recommendations
- For very large sites, consider increasing `maxPages` limit
- Monitor crawl duration for SPAs (they take longer)
- Use appropriate `maxDepth` to avoid excessive crawling

## Usage

### Starting a Crawl

```bash
POST /api/crawl
{
  "websites": ["https://spa-example.com"],
  "maxDepth": 3,
  "maxPages": 500
}
```

### Downloading Sitemaps

```bash
# JSON format
GET /api/crawl/{jobId}/download/json

# XML format (for search engines)
GET /api/crawl/{jobId}/download/xml

# Tree diagram
GET /api/crawl/{jobId}/download/tree
```

## Frontend Integration

The JobDetails component now includes download buttons for all three formats:
- ðŸ“¥ Download JSON
- ðŸ“¥ Download XML
- ðŸ“¥ Download Tree

All downloads are available once the crawl completes.

## Best Practices

1. **For SPAs:**
   - Use History API instead of hash routing
   - Ensure all routes are accessible via direct URL
   - Pre-render critical content when possible

2. **For Crawling:**
   - Set appropriate `maxDepth` based on site structure
   - Allow sufficient time for JavaScript rendering
   - Monitor crawl progress for large sites

3. **For SEO:**
   - Use XML sitemap for search engine submission
   - Review tree diagram for site structure insights
   - Check AI recommendations for optimization

## Troubleshooting

### SPA Not Being Crawled Properly

1. **Check JavaScript Console:**
   - Look for errors in browser console
   - Verify JavaScript is executing

2. **Verify Router Configuration:**
   - Ensure History API is enabled
   - Check that routes are accessible directly

3. **Increase Wait Times:**
   - For very slow SPAs, you may need to adjust timeouts
   - Check network tab for slow API calls

### Missing Links

1. **Check Lazy Loading:**
   - Verify scroll-based content is loading
   - Ensure infinite scroll is working

2. **Router Links:**
   - Verify router-based navigation is detected
   - Check for custom navigation components

3. **Dynamic Content:**
   - Ensure AJAX/fetch requests complete
   - Verify content is rendered before link extraction

## Future Enhancements

- [ ] Support for Web Components
- [ ] Detection of iframe-based content
- [ ] Handling of shadow DOM
- [ ] Support for WebAssembly-rendered content
- [ ] Automatic detection of SPA framework
- [ ] Framework-specific optimizations

